{% extends 'layout.html' %}
{% block content %}
<div class="container mt-5">
    <h2>Crear Usuario</h2>
    <form  id = 'crear-usuario-form'>
        <div class="mb-3">
            <label for="nombre">Nombre de usuario:</label>
            <input type="text" class="form-control form-control-sm" id="nombre" name="nombre" placeholder="Ej. Juan Pérez" required>
            <small>Por favor, ingresa solo tu primer nombre y primer apellido.</small>
            <div class="text-danger" id="nombreError"></div>
            
        </div>

        <div class="mb-3">
            <label for="email">Email:</label>
            <input type="email" class="form-control form-control-sm" id="email" name="email" required>
            <div class="text-danger" id="emailError"></div>
        </div>

        <div class="mb-3">
            <label for="contraseña">Contraseña:</label>
            <input type="password" class="form-control form-control-sm" id="contraseña" name="contraseña" required>
            <div class="text-danger" id="contrasenaError"></div>
        </div>

        <div class="mb-3">
            <label for="rol">Rol:</label>
            <select id="rol" name="rol" class="form-control form-control-sm" required>
                <option value="">Seleccione un rol</option>
                <option value="admin">Admin</option>
                <option value="vendedor">Vendedor</option>
            </select>
            <div class="text-danger" id="contraseñaError"></div>
        </div>
        
        <button type="submit" class="btn btn-primary form-control-sm">Crear Usuario</button>
    </form>
</div>

<script>
    $(document).ready(function() {
        $('#crear-usuario-form').on('submit', function(event) {
            event.preventDefault(); // Evita el envío normal del formulario

            // Limpiar mensajes de error previos
            $('#nombreError').text('');
            $('#emailError').text('');
            $('#contrasenaError').text('');
            $('#rolError').text('');
            $('#mensajeErrorGeneral').text('');

            // Serializar datos del formulario
            var formData = $(this).serialize();

            $.ajax({
                url: "{{ url_for('usuarios_crear') }}",
                method: "POST",
                data: formData,
                dataType: 'json',
                success: function(response) {
                    // Redirige o muestra un mensaje de éxito si el usuario fue creado correctamente
                    if (response.success) {
                        window.location.href = "{{ url_for('usuarios_ver') }}";
                    }
                },
                error: function(xhr) {
                    console.log(xhr.responseJSON); 

                    const errores = xhr.responseJSON ? xhr.responseJSON.errores : {};

                    // Mostrar mensajes de error específicos para cada campo
                    if (errores.nombre) {
                        $('#nombreError').text(errores.nombre);
                    }
                    if (errores.email) {
                        $('#emailError').text(errores.email);
                    }
                    if (errores.contrasena) {
                        $('#contrasenaError').text(errores.contrasena);
                    }
                    if (errores.rol) {
                        $('#rolError').text(errores.rol);
                    }

                    // Mostrar mensaje de error general si existen otros errores
                    if (Object.keys(errores).length > 0) {
                        $('#mensajeErrorGeneral').text("Corrige los errores en el formulario antes de guardar.");
                    } else if (xhr.responseJSON && xhr.responseJSON.message) {
                        $('#mensajeErrorGeneral').text(xhr.responseJSON.message);
                    } else {
                        $('#mensajeErrorGeneral').text('Ocurrió un error inesperado. Inténtalo nuevamente.');
                    }
                }
            });
        });
    });
</script>


{% endblock %}


    

   