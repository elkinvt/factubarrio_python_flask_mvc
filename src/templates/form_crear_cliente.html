{% extends 'layout.html' %}
{% block content %}
<div class="container mt-5">
    <h2>Registrar Cliente</h2>
    <div id="mensajeErrorGeneral" class="text-danger"></div>
    <form  id="formCliente">
        <div class="mb-3">
            <label for="tipoDocumento" class="form-label">Tipo de Documento</label>
            <select class="form-control form-control-sm" id="tipoDocumento" name="tipoDocumento" required>
                <option value="">Seleccione tipo de documento</option>
                <option value="CC">Cédula de Ciudadanía</option>
                <option value="TI">Tarjeta de Identidad</option>
                <option value="CE">Cédula de Extranjería</option>
                <option value="PA">Pasaporte</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="numeroDocumento" class="form-label">Número de Documento</label>
            <input type="text" class="form-control form-control-sm" id="numeroDocumento" name="numeroDocumento" required>
            <div id="numeroDocumentoError" class="text-danger"></div> <!-- Error en tiempo real -->
            
        </div>
        <div class="mb-3">
            <label for="nombreCliente" class="form-label">Nombre</label>
            <input type="text" class="form-control form-control-sm" id="nombreCliente" name="nombreCliente" required>
        </div>
        <div class="mb-3">
            <label for="telefonoCliente" class="form-label">Teléfono</label>
            <input type="tel" class="form-control form-control-sm" id="telefonoCliente" name="telefonoCliente" required>
        </div>
        <div class="mb-3">
            <label for="direccionCliente" class="form-label">Dirección</label>
            <input type="text" class="form-control form-control-sm" id="direccionCliente" name="direccionCliente" required>
        </div>
        <div class="mb-3">
            <label for="emailCliente" class="form-label">Email</label>
            <input type="email" class="form-control form-control-sm" id="emailCliente" name="emailCliente" required>
            <div id="emailClienteError" class="text-danger"></div> <!-- Error en tiempo real -->
        </div>
        <button type="submit" class="btn btn-primary form-control-sm">Guardar Cliente</button>
    </form>
</div>


<!-- Código JavaScript para manejar el envío con AJAX -->
<script>
    $('#formCliente').on('submit', function(event) {
        event.preventDefault();  // Evitar el envío estándar del formulario

        // Recopilar datos del formulario
        const tipoDocumento = $('#tipoDocumento').val();
        const numeroDocumento = $('#numeroDocumento').val();
        const nombreCliente = $('#nombreCliente').val();
        const telefonoCliente = $('#telefonoCliente').val();
        const direccionCliente = $('#direccionCliente').val();
        const emailCliente = $('#emailCliente').val();

        // Enviar datos al backend con AJAX
        $.ajax({
            type: 'POST',
            url: '/clientes_crear',
            contentType: 'application/json',  // Especifica que el contenido es JSON
            data: JSON.stringify({
                tipoDocumento: tipoDocumento,
                numeroDocumento: numeroDocumento,
                nombreCliente: nombreCliente,
                telefonoCliente: telefonoCliente,
                direccionCliente: direccionCliente,
                emailCliente: emailCliente
            }),
            success: function(response) {
                alert(response.message);
                window.location.href = '/ver_clientes';
            },
            error: function(xhr) {
            const errores = xhr.responseJSON.errores || {};
            $('#numeroDocumentoError').text(errores.numeroDocumento || '');
            $('#emailClienteError').text(errores.emailCliente || '');

            // Mostrar mensaje de error general en caso de errores específicos
            if (Object.keys(errores).length > 0) {
                $('#mensajeErrorGeneral').text("Corrige los errores en el formulario antes de guardar.");
            } else if (xhr.responseJSON.message) {
                // Mostrar mensaje de error general si hay otro tipo de error
                $('#mensajeErrorGeneral').text(xhr.responseJSON.message);
            } else {
                $('#mensajeErrorGeneral').text('');
            }
        }
    });
});
</script>


<!-- Código JavaScript para validacion de datos del cliente -->
<script>
    // Asignar la validación solo a los campos específicos
    $('#numeroDocumento').on('blur', function() {
        validarCliente('numeroDocumento');
    });

    $('#emailCliente').on('blur', function() {
        validarCliente('emailCliente');
    });

    function validarCliente(campo) {
        // Recopilar los valores de los campos
        const numeroDocumento = $('#numeroDocumento').val().trim();
        const emailCliente = $('#emailCliente').val().trim();

        // Crear un objeto de datos para enviar solo los campos que deben validarse
        const datos = {};
        if (campo === 'numeroDocumento' && numeroDocumento !== '') {
            datos.numeroDocumento = numeroDocumento;
        }
        if (campo === 'emailCliente' && emailCliente !== '') {
            datos.emailCliente = emailCliente;
        }

        // Si no hay datos que validar, salir de la función
        if (Object.keys(datos).length === 0) return;

        // Enviar datos al backend para validación
        $.ajax({
            type: 'POST',
            url: '/validar_cliente',
            contentType: 'application/json',
            data: JSON.stringify(datos),
            success: function(response) {
                // Limpiar mensajes de error para los campos que se están validando
                if (campo === 'numeroDocumento') {
                    $('#numeroDocumentoError').text('');
                }
                if (campo === 'emailCliente') {
                    $('#emailClienteError').text('');
                }
            },
            error: function(xhr) {
                const errores = xhr.responseJSON.errores || {};
                // Mostrar mensajes de error específicos solo para los campos que se están validando
                if (campo === 'numeroDocumento') {
                    $('#numeroDocumentoError').text(errores.numeroDocumento || '');
                }
                if (campo === 'emailCliente') {
                    $('#emailClienteError').text(errores.emailCliente || '');
                }
            }
        });
    }
</script>




{% endblock %}



    

    