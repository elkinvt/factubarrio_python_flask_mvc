{% extends 'layout.html' %}
{% block content %}

<div class="container mt-5">
    {% if not usuario %}
        <h2>Buscar usuario</h2>
        <form action="/usuarios_editar" method="GET">
            <label for="buscarusuario" class="form-label">nombre usuario:</label>
            <input type="text" placeholder="Ingrese nombre de usuario para buscar" class="form-control form-control-sm"
                name="nombre">

            <button type="submit" class="btn btn-primary mt-2 form-control-sm">Buscar usuario</button>
        </form>
    {% endif %}
</div>

{% if usuario %}
<div class="container mt-5">
    <h2>Editar usuario</h2>
    <form id="formEditarusuario">
        <!-- Incluye el ID del usuario como un campo oculto -->
        <input type="hidden" id="usuarioId" name="usuarioId" value="{{ usuario['id_usuario'] }}">

        <div class="mb-3">
            <label for="nombre">Nombre de usuario:</label>
            <input type="text" class="form-control form-control-sm" id="nombre" name="nombreUsuario" placeholder="Ej. Juan Pérez" value="{{ usuario['nombres_usuario'] }}" required>
            <small>Por favor, ingresa solo tu primer nombre y primer apellido.</small>
            <div class="text-danger" id="nombreUsuarioError"></div>

        </div>

        <div class="mb-3">
            <label for="email">Email:</label>
            <input type="email" class="form-control form-control-sm" id="email" name="emailUsuario" value="{{ usuario['email'] }}" oninput="verificarEmail(this.value)" required>
            <div class="text-danger" id="emailUsuarioError"></div>
        </div>

        <div class="mb-3">
            <label for="nuevaContraseña">Nueva Contraseña:</label>
            <input type="password" class="form-control form-control-sm" id="nuevaContraseña" name="nuevaContraseña" placeholder="Dejar en blanco si no deseas cambiarla">
            <div class="text-danger" id="nuevaContraseñaError"></div>
        </div>

        <div class="mb-3">
            <label for="confirmarContraseña">Confirmar Nueva Contraseña:</label>
            <input type="password" class="form-control form-control-sm" id="confirmarContraseña" name="confirmarContraseña" placeholder="Reingresa la nueva contraseña">
            <div class="text-danger" id="confirmarContraseñaError"></div>
        </div>

        <div class="mb-3">
            <label for="rol">Rol:</label>
            <select id="rol" name="rolUsuario" class="form-control form-control-sm" required>
                <option value="">Seleccione un rol</option>
                <option value="admin" {%if usuario['rol'] == 'admin' %} selected{% endif %}>Admin</option>
                <option value="vendedor" {%if usuario['rol'] == 'vendedor' %} selected{% endif %}>Vendedor</option>
            </select>
            <div class="text-danger" id="rolUsuarioError"></div>
        </div>

        <div class="mb-3">
            <label for="estadoCliente" class="form-label">Estado del usuario</label>
            <input type="text" class="form-control form-control-sm" id="estadousuario" name="estadousuario"
                value="{{ 'Activo' if usuario['is_active'] else 'Inactivo' }}" readonly>
            <div class="text-danger" id="estadousuarioError"></div>
        </div>

        <div class="d-flex justify-content-center">
            <button type="submit" class="btn btn-primary form-control-sm">Guardar Cambios</button>
        </div>
    </form>

    <!-- Bloquear/Desbloquear usuario -->
    <form action="/usuario_toggle_estado" method="POST" class="mt-3">
        <input type="hidden" name="nombreUsuario" value="{{ usuario['nombres_usuario'] }}">
        <button type="submit" class="btn btn-warning mb-2"> {% if usuario['is_active'] %}
            Desactivar usuario
        {% else %}
            Activar usuario
        {% endif %}</button>
    </form>

   <!-- Eliminar usuario -->
    <form id="eliminarUsuarioForm" action="/usuario_eliminar" method="POST" class="mt-2">
        <input type="hidden" name="nombreUsuario" value="{{ usuario['nombres_usuario'] }}">
        <button type="button" class="btn btn-danger" onclick="confirmarEliminarUsuario()">Eliminar usuario</button>
    </form>

</div>


<script>
    $(document).ready(function () {
        $('#formEditarusuario').on('submit', function (event) {
            event.preventDefault(); // Evitar el envío estándar del formulario

            // Serializar datos del formulario
            var formData = $(this).serialize();

            // Enviar datos al backend con AJAX
            $.ajax({
                type: 'POST',
                url: '/usuarios_actualizar',
                data: formData,
                dataType: 'json', // Especifica que el backend responde en JSON
                success: function (response) {
                    alert(response.message); // Mensaje de éxito
                    window.location.href = '/usuarios_ver'; // Redirigir al listado de usuarios
                },

                error: function (xhr) {
                    const errores = xhr.responseJSON ? xhr.responseJSON.errores : {};

                    // Limpiar mensajes de error previos
                    $('#nombreUsuarioError').text('');
                    $('#emailUsuarioError').text('');
                    $('#nuevaContraseñaError').text('');
                    $('#confirmarContraseñaError').text('');
                    $('#rolUsuarioError').text('');
                    $('#mensajeErrorGeneral').text('');

                    // Mostrar mensajes de error específicos
                    if (errores.nombreUsuario) {
                        $('#nombreUsuarioError').text(errores.nombreUsuario);
                    }
                    if (errores.emailUsuario) {
                        $('#emailUsuarioError').text(errores.emailUsuario);
                    }
                    if (errores.nuevaContraseña) {
                        $('#nuevaContraseñaError').text(errores.nuevaContraseña);
                    }
                    if (errores.confirmarContraseña) {
                        $('#confirmarContraseñaError').text(errores.confirmarContraseña);
                    }
                    if (errores.rolUsuario) {
                        $('#rolUsuarioError').text(errores.rolUsuario);
                    }

                    // Mostrar mensaje de error general si existen errores
                    if (Object.keys(errores).length > 0) {
                        $('#mensajeErrorGeneral').text("Corrige los errores en el formulario antes de guardar.");
                    } else if (xhr.responseJSON && xhr.responseJSON.message) {
                        $('#mensajeErrorGeneral').text(xhr.responseJSON.message);
                    } else {
                        $('#mensajeErrorGeneral').text('Ocurrió un error inesperado. Inténtalo nuevamente.');
                    }
                }
            });
        });
    });
</script>


<script>
    // AJAX para verificar el email en tiempo real
    function verificarEmail(email) {
    fetch(`/usuarios/verificar_email?email=${email}`)
        .then(response => response.json())
        .then(data => {
            const emailError = document.getElementById('emailUsuarioError');
            if (data.exists) {
                emailError.textContent = "Este email ya está en uso.";
            } else {
                emailError.textContent = "";
            }
        })
        .catch(error => {
            console.error('Error al verificar el email:', error);
        });
}

    
    // Confirmación antes de eliminar al usuario
    function confirmarEliminarUsuario() {
    const nombreUsuario = document.querySelector("input[name='nombreUsuario']");
    
    if (nombreUsuario) {
        console.log("Nombre de usuario a eliminar:", nombreUsuario.value);
        alert("Nombre de usuario a eliminar: " + nombreUsuario.value);  // Verifica el valor
    } else {
        console.log("El elemento con name='nombreUsuario' no se encontró.");
    }

    if (confirm("¿Estás seguro de que deseas eliminar este usuario? Esta acción no se puede deshacer.")) {
        document.getElementById('eliminarUsuarioForm').submit();
    }
}
    </script>



{% endif %}

{% endblock %}
    
    