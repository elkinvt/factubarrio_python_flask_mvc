{% extends 'layout.html' %}
{% block content %}
<div class="container mt-5">
    <h2>Registrar vendedor</h2>
    <div id="mensajeErrorGeneral" class="text-danger"></div>
    <form id="formCrearVendedor">
    <div class="mb-3">
        <label for="tipoDocumentoVendedor" class="form-label">Tipo de Documento:</label>
        <select class="form-control form-control-sm" id="tipoDocumentoVendedor" name="tipoDocumento" required>
            <option value="">Seleccione tipo de documento</option>
            <option value="CC">Cédula de Ciudadanía</option>
            <option value="TI">Tarjeta de Identidad</option>
            <option value="CE">Cédula de Extranjería</option>
            <option value="PA">Pasaporte</option>
            <option value="NIT">NIT</option>
        </select>
        <div id="tipoDocumentoError" class="text-danger"></div>
    </div>
    
    <div class="mb-3">
        <label for="numeroDocumentoVendedor" class="form-label">Número de Documento:</label>
        <input type="text" class="form-control form-control-sm" id="numeroDocumentoVendedor" name="numeroDocumento" required>
        <div id="numeroDocumentoError" class="text-danger"></div> <!-- Error en tiempo real -->
    </div>

    <div class="mb-3">
        <label for="nombreVendedor" class="form-label">Nombre Completo</label>
        <input type="text" class="form-control form-control-sm" id="nombreVendedor" name="nombreVendedor" required>
        <div id="nombreVendedorError" class="text-danger"></div>
    </div>
    
    <div class="mb-3">
        <label for="telefonoVendedor" class="form-label">Teléfono</label>
        <input type="tel" class="form-control form-control-sm" id="telefonoVendedor" name="telefonoVendedor" required>
        <div id="telefonoVendedorError" class="text-danger"></div>
    </div>

    <div class="mb-3">
        <label for="direccionVendedor" class="form-label">Dirección</label>
        <input type="text" class="form-control form-control-sm" id="direccionVendedor" name="direccionVendedor" required>
        <div id="direccionVendedorError" class="text-danger"></div>
    </div>

    <div class="mb-3">
        <label for="emailVendedor" class="form-label">Email</label>
        <input type="email" class="form-control form-control-sm" id="emailVendedor" name="emailVendedor" required>
        <div id="emailVendedorError" class="text-danger"></div> <!-- Error en tiempo real -->
    </div>

    <button type="submit" class="btn btn-primary form-control-sm">Guardar vendedor</button>
    </form>
</div>


<!-- Código JavaScript para manejar el envío con AJAX  en la creacion-->
<script>
    $(document).ready(function () {
        $('#formCrearVendedor').on('submit', function (event) {
            event.preventDefault(); // Evitar el envío tradicional del formulario

            // Obtener los datos del formulario
            var formData = $(this).serialize();

            // Enviar datos con AJAX
            $.ajax({
                type: 'POST',
                url: '/vendedores_crear',
                data: formData,
                dataType: 'json',
                success: function (response) {
                    if (response.success) {
                        alert(response.message); // Mensaje de éxito
                        window.location.href = '/vendedores_ver';
                    }
                },
                error: function (xhr) {
                     // Procesar errores específicos y mostrar mensajes en el HTML
                     const errores = xhr.responseJSON ? xhr.responseJSON.errores  : {};

                   
                    // Limpiar mensajes de error previos
                    $('#tipoDocumentoError').text('');
                    $('#numeroDocumentoError').text('');
                    $('#nombreVnededorError').text('');
                    $('#telefonoVendedorError').text('');
                    $('#direccionVendedorError').text('');
                    $('#emailVendedorError').text('');
                    $('#mensajeErrorGeneral').text('');

                    // Mostrar mensajes de error específicos;
                    if (errores.tipoDocumento) {
                        $('#tipoDocumentoError').text(errores.tipoDocumento);
                    }
                    if (errores.numeroDocumento) {
                        $('#numeroDocumentoError').text(errores.numeroDocumento);
                    }
                    if (errores.nombreVendedor) {
                        $('#nombreVendedorError').text(errores.nombreVendedor);
                    }
                    if (errores.telefonoVendedor) {
                        $('#telefonoVendedorError').text(errores.telefonoVendedor);
                    }
                    if (errores.direccionVendedor) {
                        $('#direccionVendedorError').text(errores.direccionVendedor);
                    }
                    if (errores.emailVendedor) {
                        $('#emailVendedorError').text(errores.emailVendedor);
                    }

                    

                    // Mostrar mensaje de error general si existen otros errores
                    if (Object.keys(errores).length > 0) {
                        $('#mensajeErrorGeneral').text("Corrige los errores en el formulario antes de guardar.");
                    } else if (xhr.responseJSON && xhr.responseJSON.message) {
                        $('#mensajeErrorGeneral').text(xhr.responseJSON.message);
                    } else {
                        $('#mensajeErrorGeneral').text('Ocurrió un error inesperado. Inténtalo nuevamente.');
                    }
                }
            });
        });
    });
</script>






<!-- Código JavaScript para validacion de datos duplicados(numero_documento,email) del vendedor -->
<script>
    // Asignar la validación solo a los campos específicos
    $('#numeroDocumentoVendedor').on('blur', function() {
        validarVendedor('numeroDocumento');
    });

    $('#emailVendedor').on('blur', function() {
        validarVendedor('emailVendedor');
    });

    function validarVendedor(campo) {
        // Recopilar los valores de los campos
        const numeroDocumento = $('#numeroDocumentoVendedor').val().trim();
        const emailVendedor = $('#emailVendedor').val().trim();

        // Crear un objeto de datos para enviar solo los campos que deben validarse
        const datos = {};
        if (campo === 'numeroDocumento' && numeroDocumento !== '') {
            datos.numeroDocumento = numeroDocumento;
        }
        if (campo === 'emailVendedor' && emailVendedor !== '') {
            datos.emailVendedor = emailVendedor;
        }

        // Si no hay datos que validar, salir de la función
        if (Object.keys(datos).length === 0) return;

        // Enviar datos al backend para validación
        $.ajax({
            type: 'POST',
            url: '/validar_vendedor',
            contentType: 'application/json',
            data: JSON.stringify(datos),
            success: function(response) {
                // Limpiar mensajes de error para los campos que se están validando
                if (campo === 'numeroDocumento') {
                    $('#numeroDocumentoError').text('');
                }
                if (campo === 'emailVendedor') {
                    $('#emailVendedorError').text('');
                }
            },
            error: function(xhr) {
                const errores = xhr.responseJSON.errores || {};
                // Mostrar mensajes de error específicos solo para los campos que se están validando
                if (campo === 'numeroDocumento') {
                    $('#numeroDocumentoError').text(errores.numeroDocumento || '');
                }
                if (campo === 'emailVendedor') {
                    $('#emailVendedorError').text(errores.emailVendedor || '');
                }
            }
        });
    }
</script>

{% endblock %}

    

    